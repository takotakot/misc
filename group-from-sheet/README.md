# Google Groups メンバー同期システム

Google Sheets のデータに基づいて、有効期間を管理しながら Google Groups のメンバーを自動的に同期するシステムです。

## 機能

- **時間ベースのメンバーシップ管理**: 開始時刻と終了時刻に基づいて、自動的にメンバーの追加・削除を行います
- **宣言的な調整**: シートの内容を「正」とし、グループの状態を常にシートと一致させます
- **操作除外ユーザー**: 管理者など、システムによる操作を除外するユーザーを設定できます
- **二重ロック機構**: シートロックと LockService の二段階ロックで同時実行を防止します
- **指数バックオフ**: ロック取得に失敗した場合、最大3分間リトライします

## 前提条件

1. Google Workspace アカウント
2. Google Groups の管理権限
3. Google Apps Script プロジェクト
4. Cloud Identity Groups API の有効化（Advanced Service として）

## セットアップ

### 1. Google シートの準備

以下の構造でスプレッドシートを作成してください（**シート名は固定**です）：

**1. データ管理用シート**
- **シート名**: `同期リスト`
- **列構成**:

| A列: グループメール | B列: メンバーメール | C列: 開始時刻 | D列: 終了時刻 | E列: メンバーシップ名 |
|-------------------|-------------------|-------------|-------------|----------------|
| group@example.com | user1@example.com | 2025/01/01 09:00 | 2025/12/31 23:59 | （自動入力） |
| group@example.com | user2@example.com | 2025/06/01 00:00 | 2025/06/30 23:59 | （自動入力） |

**2. 設定用シート**
- **シート名**: `システム設定`
- **セルの役割**:
    - `B1`: ロックセル（"ON" または空欄）
    - `B2`: 最終操作時刻（自動更新）

### 2. スクリプトプロパティの設定

1. GAS プロジェクトで「プロジェクトの設定」→「スクリプト プロパティ」を開く
2. 以下のプロパティを追加:
   - キー: `EXCLUDED_USERS`
   - 値: カンマ区切りのメールアドレス（例: `admin@example.com,owner@example.com`）

### 3. Cloud Identity Groups API の有効化

1. GAS エディタで「サービス」→「サービスを追加」をクリック
2. 「Cloud Identity Groups API」を検索して追加
3. 識別子を `CloudIdentityGroups` に設定

### 4. ビルドとデプロイ

```shell
# 依存関係のインストール
npm install

# TypeScript のビルド
npm run build

# GAS プロジェクトにデプロイ
npm run deploy
```

### 5. トリガーの設定

1. GAS エディタで「トリガー」を開く
2. 新しいトリガーを追加:
   - 実行する関数: `onTimeTriggered`
   - イベントのソース: 時間主導型
   - 時間ベースのトリガーのタイプ: 分ベースのタイマー
   - 時間の間隔: 5分おき

## 使い方

### 通常運用

1. スプレッドシートに追加したいメンバーの情報を記入
2. トリガーが自動的に実行され、メンバーが追加・削除されます
3. E列にメンバー名が自動的に記入されます

### メンテナンスモード

シートを手動編集したい場合:
1. ロックセル（B1）に「ON」と入力
2. シートを編集
3. 編集完了後、ロックセルを空欄に戻す

ロックセルが「ON」の間、システムは動作を停止し、変更を行いません。

## ファイル構成

```
src/
├── types.ts              # 型定義
├── config.ts             # 設定読み込み
├── lockManager.ts        # ロック管理
├── sheetReader.ts        # シート読み込み
├── sheetWriter.ts        # シート書き込み
├── groupsApiClient.ts    # Groups API クライアント
├── syncLogic.ts          # 同期ロジック
├── main.ts               # メイン処理
├── index.ts              # エントリーポイント
└── @types/
    └── cloud-identity-groups.d.ts  # API型宣言
```

## カスタマイズ

### シート構造の変更

`src/config.ts` の `getConfig()` 関数で、以下を調整できます:
- シート名
- ロックセルのアドレス
- 最終操作時刻セルのアドレス
- データ開始行

### トリガー間隔の変更

実行間隔は5分おきが推奨ですが、必要に応じて変更可能です。ただし、API クォータに注意してください。

## トラブルシューティング

### ログの確認

GAS エディタで「実行数」または「ログ」を確認してください。

### よくある問題

**Q: メンバーが追加されない**
- グループメールアドレスが正しいか確認
- 有効期間が現在時刻を含んでいるか確認
- 操作除外ユーザーリストに含まれていないか確認

**Q: "グループが見つかりません" エラー**
- Cloud Identity Groups API が有効になっているか確認
- 実行ユーザーがグループの管理権限を持っているか確認

**Q: "ScriptLock 取得がタイムアウト" エラー**
- 前回の実行が完了していない可能性があります
- しばらく待ってから再実行してください
